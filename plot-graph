#!/bin/sh

# File ID: ccf32478-1c7d-11e4-af72-000df06acc56

test "$1" = "--bezier" && { use_bezier=1; shift; } || unset use_bezier
test "$1" = "--svg" && { use_svg=1; shift; } || unset use_svg
test "$1" = "--zoom" && { use_zoom=1; shift; } || unset use_zoom
file="$1"
filebase="$(basename "$1" .dat)"

graph() {
    local column=$1
    local lt=$2
    local title=$3
    printf '"%s" using 1:%u title "%s" ' "$file" "$column" "$title"
    test -n "$use_bezier" && echo w l s b lt $lt || echo w lp pt 1 lt $lt
}

set_svg() {
    if test "$use_svg" = "1"; then
        test "$use_zoom" = "1" && { svg_str="-zoom"; } || unset svg_str
        echo set terminal svg size 800,600
        echo set output \"graph/$filebase$svg_str.svg\"
        echo set object 1 rect from screen 0, 0, 0 to screen 1, 1, 0 behind
        echo set object 1 rect fc  rgb \"white\"  fillstyle solid 1.0
    fi
}

set_yrange() {
    if test "$use_zoom" = "1"; then
        maxcount=$(cut -f 2,3,5,6 -d ' ' "$file" | fmt -1 | sort -n | tail -1)
        echo "set yrange [0.1:$maxcount]"
    else
        echo "set yrange [0.1:]"
    fi
}

cat <<END | gnuplot -persist
$(set_svg)
set xdata time
set grid
set timefmt "%Y-%m-%dT%H:%M:%SZ"
set format x "%Y-%m-%d"
$(set_yrange)
plot \
$(graph 2 1 Bazaar), \\
$(graph 3 7 CVS), \\
$(graph 4 3 Git), \\
$(graph 5 4 Mercurial), \\
$(graph 6 6 Subversion)
END
